<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrangePlanet</title>
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <link rel="stylesheet" href="style.css?v=3">
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
</head>
<body>
    <div id="app">
        <!-- Login View -->
        <div v-if="!isLoggedIn" class="login-container minimalist-theme">
            <div class="minimal-card">
                <div class="minimal-header">
                    <h1 class="fade-in-text">OrangePlanet</h1>
                    <p class="fade-in-text delay-1">您的个人助手</p>
                </div>
                <div class="minimal-form-container">
                    <div class="input-wrapper fade-in-text delay-2">
                        <input type="text" v-model="loginForm.username" placeholder=" " id="username">
                        <label for="username">请输入学号</label>
                        <div class="input-highlight"></div>
                    </div>
                    <div class="input-wrapper fade-in-text delay-3">
                        <input type="password" v-model="loginForm.password" placeholder=" " id="password" @keyup.enter="handleLogin">
                        <label for="password">请输入密码</label>
                        <div class="input-highlight"></div>
                    </div>
                    <div class="action-wrapper fade-in-text delay-4">
                        <button class="minimal-button" @click="handleLogin" :disabled="loading">
                            <span class="btn-content">登录</span>
                            <div class="btn-ripple"></div>
                        </button>
                    </div>
                </div>
            </div>
            <div class="ambient-light"></div>
        </div>

        <!-- Main App View -->
        <el-container v-else style="height: 100vh;">
            <!-- Sidebar -->
            <el-aside width="64px" class="app-sidebar">
                <el-menu
                    default-active="1"
                    background-color="#fff"
                    text-color="#606266"
                    active-text-color="#409EFF"
                    collapse
                    class="el-menu-vertical"
                >
                    <div class="logo-container">
                        <el-icon :size="30" color="#ffaa00"><Sunrise /></el-icon>
                    </div>
                    <el-menu-item index="1" @click="currentView = 'courses'">
                        <el-icon><Calendar /></el-icon>
                        <template #title>课表</template>
                    </el-menu-item>
                    <el-menu-item index="2" @click="currentView = 'desk'">
                        <el-icon><Notebook /></el-icon>
                        <template #title>书桌</template>
                    </el-menu-item>
                    <el-menu-item index="3" @click="currentView = 'emails'">
                        <el-icon><Message /></el-icon>
                        <template #title>邮箱</template>
                    </el-menu-item>
                    <el-menu-item index="4" @click="currentView = 'todos'">
                        <el-icon><List /></el-icon>
                        <template #title>待办</template>
                    </el-menu-item>
                    <el-menu-item index="5">
                        <el-icon><Setting /></el-icon>
                        <template #title>设置</template>
                    </el-menu-item>
                </el-menu>
            </el-aside>

            <el-container>
                <el-header class="app-header" style="position: relative;">
                    <div class="header-center" style="position: absolute; left: 50%; transform: translateX(-50%); display: flex; align-items: center;">
                        <img src="./logo.jpg" alt="Logo" style="width: 50px; height: 50px; margin-top: -2px;" />
                        <h2 class="brand-title" style="margin: 0;">OrangePlanet</h2>
                    </div>
                    <div class="header-left">
                        <span class="view-title">
                            <span v-if="currentView === 'courses'">我的课表</span>
                            <span v-else-if="currentView === 'emails'">我的邮箱</span>
                            <span v-else-if="currentView === 'todos'">我的待办</span>
                            <span v-else-if="currentView === 'desk'">我的书桌</span>
                        </span>
                        <template v-if="currentView === 'courses'">
                            <el-select v-model="selectedYear" placeholder="学年" style="width: 140px; margin-left: 20px;">
                                <el-option v-for="year in yearOptions" :key="year.value" :label="year.label" :value="year.value"></el-option>
                            </el-select>
                            <el-select v-model="selectedSemester" placeholder="学期" style="width: 100px; margin-left: 10px;">
                                <el-option v-for="sem in semesterOptions" :key="sem.value" :label="sem.label" :value="sem.value"></el-option>
                            </el-select>
                            <el-button type="primary" @click="refreshCourses" :loading="loading" style="margin-left: 10px;">查询</el-button>
                        </template>
                        <template v-if="currentView === 'emails'">
                            <el-input v-model="emailPassword" type="password" placeholder="客户端专用密码" show-password style="width: 200px; margin-left: 20px;"></el-input>
                            <el-button type="primary" @click="fetchEmails" :loading="loading" style="margin-left: 10px;">刷新邮件</el-button>
                        </template>
                        <template v-if="currentView === 'todos'">
                            <el-button type="primary" @click="openTodoDialog()" style="margin-left: 20px;">新建待办</el-button>
                        </template>
                        <template v-if="currentView === 'desk'">
                            <el-button type="primary" @click="fetchLearningCourses" :loading="loading" style="margin-left: 20px;">刷新课程</el-button>
                        </template>
                    </div>
                    <div class="header-right">
                        <el-button type="danger" plain size="small" @click="logout">退出登录</el-button>
                    </div>
                </el-header>
                
                <el-main style="padding: 0; overflow: hidden; display: flex; background-color: #f5f7fa;">
                    <div v-if="currentView === 'courses'" class="timetable-wrapper" style="flex: 1; overflow: auto; display: flex; padding: 20px;">
                        <!-- Time Column -->
                        <div class="time-column">
                            <div class="time-slot-header"></div>
                            <div class="time-slot" v-for="slot in timeSlots" :key="slot.id">
                                <span>{{ slot.id }}</span>
                                <span class="time-text">{{ slot.time }}</span>
                            </div>
                        </div>

                        <!-- Grid -->
                        <div class="days-grid" id="timetable-grid">
                            <!-- Headers -->
                            <div class="day-header" v-for="day in days" :key="day">{{ day }}</div>
                            
                            <!-- Grid Cells (Background) -->
                            <template v-for="row in 13">
                                <div class="grid-cell" v-for="col in 7" :key="`cell-${row}-${col}`" 
                                     :style="{ gridRow: row + 1, gridColumn: col }">
                                </div>
                            </template>

                            <!-- Course Cards -->
                            <div v-for="(course, index) in processedCourses" :key="index"
                                 class="course-card"
                                 :style="getCourseStyle(course)"
                                 @click="showDetails(course)">
                                <div class="course-name">{{ course.name }}</div>
                                <div class="course-location">{{ course.location }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Email View -->
                    <div v-if="currentView === 'emails'" class="email-wrapper" style="flex: 1; overflow: auto; padding: 20px;">
                        <el-empty v-if="emails.length === 0" description="暂无邮件"></el-empty>
                        <el-card v-for="email in emails" :key="email.id" class="email-card" shadow="hover" style="margin-bottom: 15px; cursor: pointer;" @click="showEmailDetails(email)">
                            <template #header>
                                <div class="email-header">
                                    <span class="email-subject">{{ email.subject }}</span>
                                    <span class="email-date">{{ email.date }}</span>
                                </div>
                            </template>
                            <div class="email-sender">发件人: {{ email.sender }}</div>
                            <div class="email-content-preview" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{ email.content ? email.content.substring(0, 100) + '...' : '点击查看详情' }}</div>
                        </el-card>
                    </div>

                    <!-- Todo View -->
                    <div v-if="currentView === 'todos'" class="todo-wrapper" style="flex: 1; overflow: auto; padding: 20px; background-color: #fff;">
                        <div class="todo-list">
                            <div v-for="todo in todos" :key="todo.id" class="todo-item">
                                <div class="todo-main">
                                    <el-checkbox v-model="todo.completed" @change="updateTodoStatus(todo)" size="large"></el-checkbox>
                                    <div class="todo-info">
                                        <div class="todo-title" :class="{ 'text-completed': todo.completed }">{{ todo.title }}</div>
                                        <div class="todo-desc" v-if="todo.content">{{ todo.content }}</div>
                                        <div class="todo-date" style="font-size: 12px; color: #999; margin-top: 4px;" v-if="todo.updatedAt">
                                            上次编辑: {{ formatDate(todo.updatedAt) }}
                                        </div>
                                    </div>
                                </div>
                                <div class="todo-actions">
                                    <el-button type="primary" link @click="openTodoDialog(todo)">编辑</el-button>
                                    <el-button type="danger" link @click="deleteTodo(todo.id)">删除</el-button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Desk View -->
                    <div v-if="currentView === 'desk'" class="desk-wrapper" style="flex: 1; overflow: auto; padding: 20px;">
                        <!-- Skeleton Loading -->
                        <div v-if="loading" class="learning-courses-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                            <el-card v-for="i in 8" :key="i" class="learning-course-card" shadow="never" style="padding: 0;" :body-style="{ padding: '0px' }">
                                <el-skeleton animated>
                                    <template #template>
                                        <el-skeleton-item variant="image" style="width: 100%; height: 140px;" />
                                        <div style="padding: 14px;">
                                            <el-skeleton-item variant="h3" style="width: 50%; margin-bottom: 8px;" />
                                            <el-skeleton-item variant="text" style="width: 80%;" />
                                        </div>
                                    </template>
                                </el-skeleton>
                            </el-card>
                        </div>

                        <!-- Content -->
                        <template v-else>
                            <el-empty v-if="learningCourses.length === 0" description="暂无课程"></el-empty>
                            <div v-else class="learning-courses-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                                <el-card v-for="course in learningCourses" :key="course.id" class="learning-course-card" shadow="hover" @click="showLearningDetails(course)" style="cursor: pointer; padding: 0;" :body-style="{ padding: '0px' }">
                                    <div class="course-cover" :style="getCourseCoverStyle(course)" style="height: 140px; overflow: hidden; position: relative; display: flex; align-items: center; justify-content: center;">
                                        <img v-if="course.cover" :src="course.cover" style="width: 100%; height: 100%; object-fit: cover;">
                                        <div v-else style="color: rgba(255,255,255,0.8); font-size: 24px; font-weight: bold; padding: 20px; text-align: center;">
                                            {{ course.name ? course.name.substring(0, 2) : '' }}
                                        </div>
                                    </div>
                                    <div style="padding: 14px;">
                                        <div class="learning-course-name" style="font-weight: bold; font-size: 16px; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" :title="course.name">{{ course.name }}</div>
                                        <div class="learning-course-info" style="font-size: 13px; color: #606266;">
                                            <p v-if="course.instructors && course.instructors.length > 0" style="margin: 0;">{{ course.instructors.map(i => i.name).join(', ') }}</p>
                                            <p v-else style="margin: 0;">&nbsp;</p>
                                        </div>
                                    </div>
                                </el-card>
                            </div>
                        </template>
                    </div>

                    <!-- Todo Dialog -->
                    <el-dialog v-model="todoDialogVisible" :title="currentTodo.id ? '编辑待办' : '新建待办'" width="500px">
                        <el-form :model="currentTodo" label-position="top">
                            <el-form-item label="标题">
                                <el-input v-model="currentTodo.title" placeholder="请输入标题"></el-input>
                            </el-form-item>
                            <el-form-item label="内容">
                                <el-input v-model="currentTodo.content" type="textarea" :rows="4" placeholder="请输入内容"></el-input>
                            </el-form-item>
                        </el-form>
                        <template #footer>
                            <span class="dialog-footer">
                                <el-button @click="todoDialogVisible = false">取消</el-button>
                                <el-button type="primary" @click="saveTodo">保存</el-button>
                            </span>
                        </template>
                    </el-dialog>

                    <!-- Email Detail Dialog -->
                    <el-dialog v-model="emailDialogVisible" :title="currentEmail ? currentEmail.subject : ''" width="70%">
                        <div v-if="currentEmail">
                            <div style="margin-bottom: 20px; color: #666;">
                                <p><strong>发件人:</strong> {{ currentEmail.sender }}</p>
                                <p><strong>时间:</strong> {{ currentEmail.date }}</p>
                            </div>
                            <div class="email-body" style="white-space: pre-wrap; line-height: 1.6;" v-html="currentEmail.content"></div>
                        </div>
                    </el-dialog>
                    
                    <!-- Learning Course Detail Dialog -->
                    <el-dialog v-model="learningDialogVisible" :title="currentLearningCourse ? currentLearningCourse.name : ''" width="70%">
                        <div v-if="currentLearningCourse">
                            <el-tabs v-model="learningActiveTab">
                                <el-tab-pane label="课件" name="uploads">
                                    <el-empty v-if="!courseUploads || courseUploads.length === 0" description="暂无课件"></el-empty>
                                    <ul v-else style="list-style: none; padding: 0;">
                                        <li v-for="file in courseUploads" :key="file.id" style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                            <span :title="file.title || file.file_name" style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 10px;">{{ file.title || file.file_name }}</span>
                                            <div style="flex-shrink: 0;">
                                                <el-button type="primary" link @click="downloadFile(file.url)">下载</el-button>
                                            </div>
                                        </li>
                                    </ul>
                                </el-tab-pane>
                                <el-tab-pane label="点名" name="rollcalls">
                                    <div style="margin-bottom: 10px;">
                                        <el-button type="primary" @click="fetchRollCalls(currentLearningCourse.id)">刷新点名</el-button>
                                    </div>
                                    <el-empty v-if="!courseRollCalls || courseRollCalls.length === 0" description="暂无点名"></el-empty>
                                    <div v-else class="rollcall-list">
                                        <div v-for="rc in courseRollCalls" :key="rc.id" class="rollcall-item">
                                            <div class="rollcall-content">
                                                <span class="rollcall-title">[{{ getRollCallType(rc) }}] {{ rc.title }}</span>
                                            </div>
                                            <el-icon><ArrowRight /></el-icon>
                                        </div>
                                    </div>
                                </el-tab-pane>
                            </el-tabs>
                        </div>
                    </el-dialog>
                    
                    <!-- Details Panel -->
                    <transition name="slide-fade">
                        <div class="details-panel" v-if="currentCourse">
                            <div class="panel-header">
                                <h3>课程详情</h3>
                                <el-button link @click="currentCourse = null"><el-icon><Close /></el-icon></el-button>
                            </div>
                            <el-descriptions :column="1" border size="large">
                                <el-descriptions-item label="课程名称">{{ currentCourse.name }}</el-descriptions-item>
                                <el-descriptions-item label="教师">{{ currentCourse.teacher }}</el-descriptions-item>
                                <el-descriptions-item label="地点">{{ currentCourse.location }}</el-descriptions-item>
                                <el-descriptions-item label="时间">{{ currentCourse.dayOfWeek }} 第{{ currentCourse.startTime }}节</el-descriptions-item>
                                <el-descriptions-item label="周次">{{ currentCourse.weeks }}</el-descriptions-item>
                                <el-descriptions-item label="学分">{{ currentCourse.credits }}</el-descriptions-item>
                                <el-descriptions-item label="成绩">{{ currentCourse.grade || '暂无' }}</el-descriptions-item>
                                <el-descriptions-item label="考试时间">{{ currentCourse.test }}</el-descriptions-item>
                            </el-descriptions>
                        </div>
                    </transition>
                </el-main>
            </el-container>
        </el-container>
    </div>
    <script src="renderer.js?v=8"></script>
</body>
</html>
