<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OrangePlanet</title>
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <link rel="stylesheet" href="style.css?v=3">
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
</head>
<body>
    <div id="app">
        <!-- Login View -->
        <div v-if="!isLoggedIn" class="login-container">
            <el-card class="login-card">
                <template #header>
                    <div class="login-header">
                        <h2>OrangePlanet</h2>
                        <p>你的个人助手</p>
                    </div>
                </template>
                <el-form :model="loginForm" label-position="top" size="large">
                    <el-form-item label="学号">
                        <el-input v-model="loginForm.username" placeholder="请输入学号" :prefix-icon="User"></el-input>
                    </el-form-item>
                    <el-form-item label="密码">
                        <el-input v-model="loginForm.password" type="password" placeholder="请输入密码" show-password :prefix-icon="Lock"></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="handleLogin" :loading="loading" style="width: 100%;">登录</el-button>
                    </el-form-item>
                </el-form>
            </el-card>
        </div>

        <!-- Main App View -->
        <el-container v-else style="height: 100vh;">
            <!-- Sidebar -->
            <el-aside width="64px" class="app-sidebar">
                <el-menu
                    default-active="1"
                    background-color="#fff"
                    text-color="#606266"
                    active-text-color="#409EFF"
                    collapse
                    class="el-menu-vertical"
                >
                    <div class="logo-container">
                        <el-icon :size="24" color="#409EFF"><ElementPlus /></el-icon>
                    </div>
                    <el-menu-item index="1" @click="currentView = 'courses'">
                        <el-icon><Calendar /></el-icon>
                        <template #title>课表</template>
                    </el-menu-item>
                    <el-menu-item index="2">
                        <el-icon><Notebook /></el-icon>
                        <template #title>书桌</template>
                    </el-menu-item>
                    <el-menu-item index="3" @click="currentView = 'emails'">
                        <el-icon><Message /></el-icon>
                        <template #title>邮箱</template>
                    </el-menu-item>
                    <el-menu-item index="4" @click="currentView = 'todos'">
                        <el-icon><List /></el-icon>
                        <template #title>待办</template>
                    </el-menu-item>
                    <el-menu-item index="5">
                        <el-icon><Setting /></el-icon>
                        <template #title>设置</template>
                    </el-menu-item>
                </el-menu>
            </el-aside>

            <el-container>
                <el-header class="app-header">
                    <div class="header-left">
                        <h2>
                            <span v-if="currentView === 'courses'">我的课表</span>
                            <span v-else-if="currentView === 'emails'">我的邮箱</span>
                            <span v-else-if="currentView === 'todos'">我的待办</span>
                            <span v-else>OrangePlanet</span>
                        </h2>
                        <template v-if="currentView === 'courses'">
                            <el-select v-model="selectedYear" placeholder="学年" style="width: 140px; margin-left: 20px;">
                                <el-option v-for="year in yearOptions" :key="year.value" :label="year.label" :value="year.value"></el-option>
                            </el-select>
                            <el-select v-model="selectedSemester" placeholder="学期" style="width: 100px; margin-left: 10px;">
                                <el-option v-for="sem in semesterOptions" :key="sem.value" :label="sem.label" :value="sem.value"></el-option>
                            </el-select>
                            <el-button type="primary" @click="refreshCourses" :loading="loading" style="margin-left: 10px;">查询</el-button>
                        </template>
                        <template v-if="currentView === 'emails'">
                            <el-input v-model="emailPassword" type="password" placeholder="客户端专用密码" show-password style="width: 200px; margin-left: 20px;"></el-input>
                            <el-button type="primary" @click="fetchEmails" :loading="loading" style="margin-left: 10px;">刷新邮件</el-button>
                        </template>
                        <template v-if="currentView === 'todos'">
                            <el-button type="primary" @click="openTodoDialog()" style="margin-left: 20px;">新建待办</el-button>
                        </template>
                    </div>
                    <div class="header-right">
                        <el-button type="danger" plain size="small" @click="logout">退出登录</el-button>
                    </div>
                </el-header>
                
                <el-main style="padding: 0; overflow: hidden; display: flex; background-color: #f5f7fa;">
                    <div v-if="currentView === 'courses'" class="timetable-wrapper" style="flex: 1; overflow: auto; display: flex; padding: 20px;">
                        <!-- Time Column -->
                        <div class="time-column">
                            <div class="time-slot-header"></div>
                            <div class="time-slot" v-for="slot in timeSlots" :key="slot.id">
                                <span>{{ slot.id }}</span>
                                <span class="time-text">{{ slot.time }}</span>
                            </div>
                        </div>

                        <!-- Grid -->
                        <div class="days-grid" id="timetable-grid">
                            <!-- Headers -->
                            <div class="day-header" v-for="day in days" :key="day">{{ day }}</div>
                            
                            <!-- Grid Cells (Background) -->
                            <template v-for="row in 13">
                                <div class="grid-cell" v-for="col in 7" :key="`cell-${row}-${col}`" 
                                     :style="{ gridRow: row + 1, gridColumn: col }">
                                </div>
                            </template>

                            <!-- Course Cards -->
                            <div v-for="(course, index) in processedCourses" :key="index"
                                 class="course-card"
                                 :style="getCourseStyle(course)"
                                 @click="showDetails(course)">
                                <div class="course-name">{{ course.name }}</div>
                                <div class="course-location">{{ course.location }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Email View -->
                    <div v-if="currentView === 'emails'" class="email-wrapper" style="flex: 1; overflow: auto; padding: 20px;">
                        <el-empty v-if="emails.length === 0" description="暂无邮件"></el-empty>
                        <el-card v-for="email in emails" :key="email.id" class="email-card" shadow="hover" style="margin-bottom: 15px;">
                            <template #header>
                                <div class="email-header">
                                    <span class="email-subject">{{ email.subject }}</span>
                                    <span class="email-date">{{ email.date }}</span>
                                </div>
                            </template>
                            <div class="email-sender">发件人: {{ email.sender }}</div>
                            <div class="email-content">{{ email.content }}</div>
                        </el-card>
                    </div>

                    <!-- Todo View -->
                    <div v-if="currentView === 'todos'" class="todo-wrapper" style="flex: 1; overflow: auto; padding: 20px;">
                        <el-row :gutter="20">
                            <el-col :span="6" v-for="todo in todos" :key="todo.id">
                                <el-card class="todo-card" shadow="hover" :class="{ 'completed': todo.completed }" @click="openTodoDialog(todo)">
                                    <template #header>
                                        <div class="todo-header">
                                            <span class="todo-title">{{ todo.title }}</span>
                                            <el-checkbox v-model="todo.completed" @change="updateTodoStatus(todo)" @click.stop></el-checkbox>
                                        </div>
                                    </template>
                                    <div class="todo-content-preview" v-html="renderMarkdown(todo.content)"></div>
                                    <div class="todo-actions">
                                        <el-button type="danger" :icon="Delete" circle size="small" @click.stop="deleteTodo(todo.id)"></el-button>
                                    </div>
                                </el-card>
                            </el-col>
                        </el-row>
                    </div>

                    <!-- Todo Dialog -->
                    <el-dialog v-model="todoDialogVisible" :title="currentTodo.id ? '编辑待办' : '新建待办'" width="70%" @opened="initEditor">
                        <el-form :model="currentTodo" label-position="top">
                            <el-form-item label="标题">
                                <el-input v-model="currentTodo.title" placeholder="请输入标题"></el-input>
                            </el-form-item>
                            <el-form-item label="内容">
                                <textarea id="markdown-editor"></textarea>
                            </el-form-item>
                        </el-form>
                        <template #footer>
                            <span class="dialog-footer">
                                <el-button @click="todoDialogVisible = false">取消</el-button>
                                <el-button type="primary" @click="saveTodo">保存</el-button>
                            </span>
                        </template>
                    </el-dialog>
                    
                    <!-- Details Panel -->
                    <transition name="slide-fade">
                        <div class="details-panel" v-if="currentCourse">
                            <div class="panel-header">
                                <h3>课程详情</h3>
                                <el-button link @click="currentCourse = null"><el-icon><Close /></el-icon></el-button>
                            </div>
                            <el-descriptions :column="1" border size="large">
                                <el-descriptions-item label="课程名称">{{ currentCourse.name }}</el-descriptions-item>
                                <el-descriptions-item label="教师">{{ currentCourse.teacher }}</el-descriptions-item>
                                <el-descriptions-item label="地点">{{ currentCourse.location }}</el-descriptions-item>
                                <el-descriptions-item label="时间">{{ currentCourse.dayOfWeek }} 第{{ currentCourse.startTime }}节</el-descriptions-item>
                                <el-descriptions-item label="周次">{{ currentCourse.weeks }}</el-descriptions-item>
                                <el-descriptions-item label="学分">{{ currentCourse.credits }}</el-descriptions-item>
                                <el-descriptions-item label="考试时间">{{ currentCourse.test }}</el-descriptions-item>
                            </el-descriptions>
                        </div>
                    </transition>
                </el-main>
            </el-container>
        </el-container>
    </div>
    <script src="renderer.js?v=6"></script>
</body>
</html>
